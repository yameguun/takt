<% provide(:title, "チーム日報管理") %>
<div id="wrapper">
  <%= render 'shared/header' %>
  <div id="page-wrapper" class="gray-bg">
    <%= render 'shared/navbar' %>
    
    <!-- ヘッダー部分 -->
    <div class="row wrapper border-bottom white-bg page-heading">
      <div class="col-lg-12">
        <h2 class="m-t-md">
          <i class="fa fa-users text-navy"></i> チーム日報管理
          <small class="m-l-sm">(<%= @target_date.strftime("%Y年%m月%d日") %>)</small>
        </h2>
        <ol class="breadcrumb">
          <li class="breadcrumb-item">
            <a href="/">ホーム</a>
          </li>
          <li class="breadcrumb-item active">
            <strong>チーム日報管理</strong>
          </li>
        </ol>
      </div>
    </div>

    <!-- メインコンテンツ -->
    <div class="wrapper wrapper-content animated fadeInRight">
      
      <!-- 日付ナビゲーション -->
      <div class="row m-b-lg">
        <div class="col-lg-12">
          <div class="ibox">
            <div class="ibox-content text-center p-lg">
              <div class="row">
                <div class="col-md-8 col-md-offset-2">
                  <div class="btn-group btn-group-justified date-navigation" role="group">
                    <a href="<%= manager_daily_reports_path(date: @prev_date) %>" 
                       class="btn btn-white btn-lg">
                      <i class="fa fa-chevron-left"></i> 前の日
                      <small class="block text-muted"><%= @prev_date.strftime("%m/%d") %></small>
                    </a>
                    
                    <div class="btn btn-primary btn-lg current-date">
                      <i class="fa fa-calendar"></i> <%= @target_date.strftime("%m月%d日") %>
                      <small class="block text-white"><%= @target_date.strftime("(%a)") %></small>
                    </div>
                    
                    <a href="<%= manager_daily_reports_path(date: @next_date) %>" 
                       class="btn btn-white btn-lg">
                      次の日 <i class="fa fa-chevron-right"></i>
                      <small class="block text-muted"><%= @next_date.strftime("%m/%d") %></small>
                    </a>
                  </div>
                  
                  <!-- 日付直接選択 -->
                  <div class="m-t-md">
                    <input type="date" 
                           class="form-control text-center" 
                           id="dateSelector" 
                           value="<%= @target_date.strftime('%Y-%m-%d') %>">
                  </div>
                </div>
              </div>
            </div>
          </div>
        </div>
      </div>

      <!-- 統計情報 -->
      <div class="row m-b-lg">
        <div class="col-lg-3 col-md-6">
          <div class="widget style1 navy-bg">
            <div class="row">
              <div class="col-xs-4">
                <i class="fa fa-file-text-o fa-3x"></i>
              </div>
              <div class="col-xs-8 text-right">
                <span>提出済み日報</span>
                <h2 class="font-bold"><%= @report_statistics[:submitted_count] %></h2>
                <small>/ <%= @report_statistics[:total_users] %>名</small>
              </div>
            </div>
          </div>
        </div>
        
        <div class="col-lg-3 col-md-6">
          <div class="widget style1 lazur-bg">
            <div class="row">
              <div class="col-xs-4">
                <i class="fa fa-percent fa-3x"></i>
              </div>
              <div class="col-xs-8 text-right">
                <span>提出率</span>
                <h2 class="font-bold"><%= @report_statistics[:submission_rate] %>%</h2>
                <small>日報提出状況</small>
              </div>
            </div>
          </div>
        </div>
        
        <div class="col-lg-3 col-md-6">
          <div class="widget style1 yellow-bg">
            <div class="row">
              <div class="col-xs-4">
                <i class="fa fa-clock-o fa-3x"></i>
              </div>
              <div class="col-xs-8 text-right">
                <span>総作業時間</span>
                <h2 class="font-bold"><%= @report_statistics[:total_work_hours] %></h2>
                <small>時間</small>
              </div>
            </div>
          </div>
        </div>
        
        <div class="col-lg-3 col-md-6">
          <div class="widget style1 red-bg">
            <div class="row">
              <div class="col-xs-4">
                <i class="fa fa-moon-o fa-3x"></i>
              </div>
              <div class="col-xs-8 text-right">
                <span>残業申請</span>
                <h2 class="font-bold"><%= @report_statistics[:overtime_requests] %></h2>
                <small>承認待ち</small>
              </div>
            </div>
          </div>
        </div>
      </div>

      <!-- フラット一覧表示 -->
      <div class="row">
        <div class="col-lg-12">
          <div class="ibox">
            <div class="ibox-title">
              <h5>
                <i class="fa fa-list"></i> 社員別日報一覧（全表示）
              </h5>
              <div class="ibox-tools">
                <span class="text-muted">
                  <i class="fa fa-info-circle"></i> 
                  すべての情報を一覧表示
                </span>
              </div>
            </div>
            <div class="ibox-content p-n">
              
              <% if @users.any? %>
                <div class="table-responsive">
                  <table class="table table-hover table-striped m-b-none">
                    <thead>
                      <tr class="table-header">
                        <th style="width: 200px;">
                          <i class="fa fa-user"></i> 社員情報
                        </th>
                        <th style="width: 80px;" class="text-center">
                          <i class="fa fa-check"></i> 提出
                        </th>
                        <th style="width: 90px;" class="text-center">
                          <i class="fa fa-clock-o"></i> 総時間
                        </th>
                        <th>
                          <i class="fa fa-tasks"></i> 作業記録
                        </th>
                        <th style="width: 350px;">
                          <i class="fa fa-file-text-o"></i> 日報内容
                        </th>
                      </tr>
                    </thead>
                    <tbody>
                      <% @users.each do |user| %>
                        <% daily_report = @reports_by_user_id[user.id] %>
                        <% works = daily_report&.daily_report_projects || [] %>
                        <% total_minutes = works.sum(&:minutes) %>
                        
                        <tr class="report-row <%= 'no-report-row' unless daily_report %>">
                          <!-- 社員情報 -->
                          <td class="user-info-cell">
                            <div class="user-profile">
                              <% if user.avatar.attached? %>
                                <%= image_tag user.avatar, 
                                  class: "img-circle user-avatar-sm", 
                                  style: "width: 42px; height: 42px; object-fit: cover;",
                                  alt: user.name %>
                              <% else %>
                                <div class="user-avatar-placeholder-sm">
                                  <i class="fa fa-user"></i>
                                </div>
                              <% end %>
                              
                              <div class="user-details-compact">
                                <div class="user-name-compact"><%= user.name %></div>
                                <small class="text-muted department-info">
                                  <i class="fa fa-building-o"></i> 
                                  <%= user.department&.name || '部署未設定' %>
                                </small>
                              </div>
                            </div>
                          </td>

                          <!-- 提出状況 -->
                          <td class="text-center status-cell">
                            <% if daily_report %>
                              <span class="label label-primary label-status">
                                <i class="fa fa-check"></i> 提出済み
                              </span>
                            <% else %>
                              <span class="label label-default label-status">
                                <i class="fa fa-times"></i> 未提出
                              </span>
                            <% end %>
                          </td>

                          <!-- 総作業時間 -->
                          <td class="text-center time-cell">
                            <% if daily_report && total_minutes > 0 %>
                              <div class="work-time-display">
                                <span class="hours-number <%= total_minutes > 480 ? 'overtime-hours' : 'normal-hours' %>">
                                  <%= (total_minutes / 60.0).round(1) %>
                                </span>
                                <small class="hours-unit">時間</small>
                                <% if total_minutes > 480 %>
                                  <div class="overtime-badge">
                                    <span class="label label-warning">
                                      <i class="fa fa-moon-o"></i> 残業
                                    </span>
                                  </div>
                                <% end %>
                              </div>
                            <% else %>
                              <span class="text-muted">-</span>
                            <% end %>
                          </td>

                          <!-- 作業記録 -->
                          <td class="work-records-cell">
                            <% if daily_report && works.any? %>
                              <div class="work-items-compact">
                                <% works.each_with_index do |work, index| %>
                                  <div class="work-item-row <%= 'work-item-border' if index > 0 %>">
                                    <div class="work-item-content">
                                      <div class="client-project-info">
                                        <span class="client-name">
                                          <i class="fa fa-building text-info"></i>
                                          <%= work.project&.client&.name || '不明' %>
                                        </span>
                                        <span class="project-name">
                                          <i class="fa fa-folder-open text-success"></i>
                                          <%= work.project&.name || '不明' %>
                                        </span>
                                      </div>
                                      
                                      <div class="work-meta">
                                        <span class="work-duration">
                                          <i class="fa fa-clock-o"></i>
                                          <%= (work.minutes / 60.0).round(1) %>h
                                        </span>
                                        
                                        <% if work.is_overtime_approved %>
                                          <span class="overtime-status overtime-approved">
                                            <i class="fa fa-check-circle"></i> 承認済み
                                          </span>
                                        <% elsif work.is_overtime_requested %>
                                          <span class="overtime-status overtime-pending">
                                            <i class="fa fa-clock-o"></i> 申請中
                                          </span>
                                        <% end %>
                                      </div>
                                      
                                      <% if work.description.present? %>
                                        <div class="work-description-compact">
                                          <%= truncate(work.description, length: 60) %>
                                        </div>
                                      <% end %>
                                    </div>
                                  </div>
                                <% end %>
                              </div>
                            <% elsif daily_report %>
                              <span class="text-muted">作業記録なし</span>
                            <% else %>
                              <span class="text-muted">-</span>
                            <% end %>
                          </td>

                          <!-- 日報内容 -->
                          <td class="report-content-cell">
                            <% if daily_report && daily_report.content.present? %>
                              <div class="report-content-preview">
                                <%= simple_format(truncate(h(daily_report.content), length: 150)) %>
                                <% if daily_report.content.length > 150 %>
                                  <button class="btn btn-xs btn-link show-full-content" 
                                          data-content="<%= h(daily_report.content) %>">
                                    <i class="fa fa-expand"></i> 全文表示
                                  </button>
                                <% end %>
                              </div>
                            <% elsif daily_report %>
                              <span class="text-muted">記載なし</span>
                            <% else %>
                              <span class="text-muted">-</span>
                            <% end %>
                          </td>
                        </tr>
                      <% end %>
                    </tbody>
                  </table>
                </div>
              <% else %>
                <div class="empty-state text-center p-xl">
                  <i class="fa fa-users fa-4x text-muted m-b-md"></i>
                  <h3 class="text-muted">社員データが見つかりません</h3>
                </div>
              <% end %>
            </div>
          </div>
        </div>
      </div>
    </div>
    
    <%= render 'shared/footer' %>
  </div>
</div>

<!-- 日報内容全文表示モーダル -->
<div class="modal fade" id="reportContentModal" tabindex="-1" role="dialog">
  <div class="modal-dialog modal-lg" role="document">
    <div class="modal-content">
      <div class="modal-header">
        <button type="button" class="close" data-dismiss="modal" aria-label="Close">
          <span aria-hidden="true">&times;</span>
        </button>
        <h4 class="modal-title">
          <i class="fa fa-file-text-o"></i> 日報内容（全文）
        </h4>
      </div>
      <div class="modal-body">
        <div id="fullReportContent" class="report-full-content"></div>
      </div>
      <div class="modal-footer">
        <button type="button" class="btn btn-default" data-dismiss="modal">閉じる</button>
      </div>
    </div>
  </div>
</div>

<style>
/* ===== フラット一覧表示専用スタイル ===== */

/* 日付ナビゲーション */
.date-navigation .btn {
  transition: all 0.3s ease;
}

.date-navigation .btn:hover:not(.current-date) {
  transform: translateY(-2px);
  box-shadow: 0 4px 8px rgba(0,0,0,0.1);
}

.current-date {
  cursor: default !important;
}

/* テーブル全体 */
.table-header {
  background: linear-gradient(135deg, #f8f9fa 0%, #e9ecef 100%);
  border-bottom: 2px solid #1ab394;
}

.table-header th {
  font-weight: 700;
  color: #2f4050;
  vertical-align: middle;
  padding: 15px 12px;
  border-bottom: 2px solid #1ab394;
}

.report-row {
  transition: all 0.3s ease;
  border-left: 3px solid transparent;
}

.report-row:hover {
  background-color: #f8f9fa;
  border-left-color: #1ab394;
}

.report-row.no-report-row {
  background-color: #fefefe;
  border-left-color: #f8ac59;
}

.report-row.no-report-row:hover {
  background-color: #fff9e6;
}

/* ユーザー情報セル */
.user-info-cell {
  padding: 15px 12px;
}

.user-profile {
  display: flex;
  align-items: center;
  gap: 12px;
}

.user-avatar-sm {
  border: 2px solid #e7eaec;
  transition: border-color 0.3s ease;
}

.report-row:hover .user-avatar-sm {
  border-color: #1ab394;
}

.user-avatar-placeholder-sm {
  width: 42px;
  height: 42px;
  border-radius: 50%;
  background: #e7eaec;
  display: flex;
  align-items: center;
  justify-content: center;
  color: #999;
  font-size: 16px;
  border: 2px solid #e7eaec;
  transition: all 0.3s ease;
}

.report-row:hover .user-avatar-placeholder-sm {
  border-color: #1ab394;
  background: #f0f8f7;
  color: #1ab394;
}

.user-details-compact {
  flex: 1;
}

.user-name-compact {
  font-size: 15px;
  font-weight: 600;
  color: #2f4050;
  margin-bottom: 2px;
}

.department-info {
  font-size: 12px;
  color: #676a6c;
}

/* ステータスセル */
.status-cell {
  padding: 15px 8px;
  vertical-align: middle;
}

.label-status {
  font-size: 10px;
  padding: 6px 10px;
  border-radius: 12px;
  font-weight: 600;
}

/* 時間セル */
.time-cell {
  padding: 15px 8px;
  vertical-align: middle;
}

.work-time-display {
  text-align: center;
}

.hours-number {
  font-size: 18px;
  font-weight: 700;
  display: block;
  line-height: 1.2;
}

.normal-hours {
  color: #1ab394;
}

.overtime-hours {
  color: #f8ac59;
}

.hours-unit {
  font-size: 11px;
  color: #676a6c;
  display: block;
  margin-top: 2px;
}

.overtime-badge {
  margin-top: 5px;
}

/* 作業記録セル */
.work-records-cell {
  padding: 12px;
  vertical-align: top;
}

.work-items-compact {
  max-height: 200px;
  overflow-y: auto;
}

.work-item-row {
  padding: 8px 0;
}

.work-item-border {
  border-top: 1px solid #f1f1f1;
  margin-top: 8px;
  padding-top: 8px;
}

.work-item-content {
  font-size: 12px;
}

.client-project-info {
  margin-bottom: 4px;
}

.client-name, .project-name {
  display: block;
  margin-bottom: 2px;
  color: #495057;
}

.client-name i {
  color: #17a2b8;
  margin-right: 4px;
}

.project-name i {
  color: #28a745;
  margin-right: 4px;
}

.work-meta {
  display: flex;
  align-items: center;
  gap: 8px;
  margin-bottom: 4px;
}

.work-duration {
  background: #e9ecef;
  padding: 2px 6px;
  border-radius: 8px;
  font-size: 11px;
  font-weight: 600;
  color: #495057;
}

.overtime-status {
  font-size: 10px;
  padding: 2px 6px;
  border-radius: 8px;
  font-weight: 600;
}

.overtime-approved {
  background: #d4edda;
  color: #155724;
}

.overtime-pending {
  background: #fff3cd;
  color: #856404;
}

.work-description-compact {
  font-size: 11px;
  color: #6c757d;
  line-height: 1.3;
  margin-top: 4px;
}

/* 日報内容セル */
.report-content-cell {
  padding: 12px;
  vertical-align: top;
}

.report-content-preview {
  font-size: 12px;
  line-height: 1.4;
  color: #495057;
  max-height: 120px;
  overflow: hidden;
}

.show-full-content {
  padding: 2px 6px;
  margin-top: 5px;
  font-size: 11px;
}

/* モーダル */
.report-full-content {
  font-size: 14px;
  line-height: 1.6;
  color: #495057;
  white-space: pre-wrap;
  max-height: 400px;
  overflow-y: auto;
}

/* レスポンシブ対応 */
@media (max-width: 1200px) {
  .work-records-cell,
  .report-content-cell {
    font-size: 11px;
  }
  
  .table th:nth-child(4),
  .table td:nth-child(4) {
    max-width: 250px;
  }
  
  .table th:nth-child(5),
  .table td:nth-child(5) {
    max-width: 200px;
  }
}

@media (max-width: 992px) {
  .user-profile {
    flex-direction: column;
    align-items: flex-start;
    gap: 8px;
  }
  
  .work-meta {
    flex-direction: column;
    align-items: flex-start;
    gap: 4px;
  }
  
  .table th:nth-child(4),
  .table td:nth-child(4),
  .table th:nth-child(5),
  .table td:nth-child(5) {
    display: none;
  }
}

@media (max-width: 768px) {
  .date-navigation .btn small {
    display: none;
  }
  
  .btn-group-justified {
    display: flex;
    flex-direction: column;
  }
  
  .btn-group-justified .btn {
    border-radius: 4px !important;
    margin-bottom: 5px;
  }
  
  .current-date {
    order: -1;
    margin-bottom: 15px;
  }
  
  .table-responsive {
    font-size: 11px;
  }
}

/* スクロールバーのスタイリング */
.work-items-compact::-webkit-scrollbar,
.report-full-content::-webkit-scrollbar {
  width: 4px;
}

.work-items-compact::-webkit-scrollbar-track,
.report-full-content::-webkit-scrollbar-track {
  background: #f1f1f1;
  border-radius: 2px;
}

.work-items-compact::-webkit-scrollbar-thumb,
.report-full-content::-webkit-scrollbar-thumb {
  background: #1ab394;
  border-radius: 2px;
}

.work-items-compact::-webkit-scrollbar-thumb:hover,
.report-full-content::-webkit-scrollbar-thumb:hover {
  background: #17987e;
}
</style>

<script>
$(document).ready(function() {
  
  // 日付選択機能
  $('#dateSelector').on('change', function() {
    const selectedDate = $(this).val();
    if (selectedDate) {
      window.location.href = '<%= manager_daily_reports_path %>?date=' + selectedDate;
    }
  });
  
  // 全文表示ボタン
  $(document).on('click', '.show-full-content', function() {
    const fullContent = $(this).data('content');
    $('#fullReportContent').html(fullContent.replace(/\n/g, '<br>'));
    $('#reportContentModal').modal('show');
  });
  
  // 統計ウィジェットのアニメーション
  $('.widget h2').each(function() {
    const $this = $(this);
    const countTo = parseFloat($this.text());
    
    if (!isNaN(countTo)) {
      $({ countNum: 0 }).animate({
        countNum: countTo
      }, {
        duration: 1000,
        easing: 'swing',
        step: function() {
          if (countTo % 1 === 0) {
            $this.text(Math.floor(this.countNum));
          } else {
            $this.text(this.countNum.toFixed(1));
          }
        },
        complete: function() {
          $this.text(countTo % 1 === 0 ? countTo : countTo.toFixed(1));
        }
      });
    }
  });
  
  // 作業時間のアニメーション
  $('.hours-number').each(function() {
    const $this = $(this);
    const countTo = parseFloat($this.text());
    
    if (!isNaN(countTo)) {
      $({ countNum: 0 }).animate({
        countNum: countTo
      }, {
        duration: 1200,
        easing: 'swing',
        step: function() {
          $this.text(this.countNum.toFixed(1));
        },
        complete: function() {
          $this.text(countTo.toFixed(1));
        }
      });
    }
  });
  
  // テーブル行のホバー効果
  $('.report-row').hover(
    function() {
      $(this).find('.hours-number').addClass('text-primary');
    },
    function() {
      $(this).find('.hours-number').removeClass('text-primary');
    }
  );
});
</script>
