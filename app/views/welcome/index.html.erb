<% provide(:title, "ダッシュボード") %>
<div id="wrapper">
  <%= render 'shared/header' %>
  <div id="page-wrapper" class="gray-bg">
    <%= render 'shared/navbar' %>
    
    <!-- ヘッダー部分 -->
    <div class="row wrapper border-bottom white-bg page-heading">
      <div class="col-lg-8">
        <h2 class="m-t-md">
          <i class="fa fa-th-large text-navy"></i> ダッシュボード
        </h2>
        <ol class="breadcrumb">
          <li class="breadcrumb-item active">
            <strong>ダッシュボード</strong>
          </li>
        </ol>
      </div>
      
      <!-- 月選択ドロップダウン -->
      <div class="col-lg-4">
        <% if @available_months.present? %>
          <div class="m-t-lg text-right">
            <label class="m-r-sm">表示月:</label>
            <select id="month-filter" class="form-control input-sm" style="display:inline-block; width:auto;">
              <% @available_months.each do |m| %>
                <option value="<%= root_path(month: m[:value]) %>" <%= 'selected' if m[:value] == @selected_month_ym %>>
                  <%= m[:label] %>
                </option>
              <% end %>
            </select>
          </div>
        <% end %>
      </div>
    </div>
    
    <!-- メインコンテンツ -->
    <div class="wrapper wrapper-content animated fadeInRight">
      
      <!-- 統計カード -->
      <div class="row">
        <div class="col-lg-3">
          <div class="ibox float-e-margins">
            <div class="ibox-title">
              <span class="label label-danger pull-right"><%= @current_month %></span>
              <h5>上限到達者</h5>
            </div>
            <div class="ibox-content">
              <h1 class="no-margins text-danger">
                <%= @users.select { |u| u.total_hours >= @overtime_limit }.count %>
              </h1>
              <small>45時間以上</small>
            </div>
          </div>
        </div>
        <div class="col-lg-3">
          <div class="ibox float-e-margins">
            <div class="ibox-title">
              <span class="label label-warning pull-right"><%= @current_month %></span>
              <h5>要注意者</h5>
            </div>
            <div class="ibox-content">
              <h1 class="no-margins text-warning">
                <%= @users.select { |u| u.total_hours >= (@overtime_limit * 0.8) && u.total_hours < @overtime_limit }.count %>
              </h1>
              <small>36時間以上</small>
            </div>
          </div>
        </div>
        <div class="col-lg-3">
          <div class="ibox float-e-margins">
            <div class="ibox-title">
              <span class="label label-info pull-right"><%= @current_month %></span>
              <h5>平均残業時間</h5>
            </div>
            <div class="ibox-content">
              <h1 class="no-margins">
                <%= number_with_precision(@users.average(:total_hours) || 0, precision: 1) %>h
              </h1>
              <small>全社員平均</small>
            </div>
          </div>
        </div>
        <div class="col-lg-3">
          <div class="ibox float-e-margins">
            <div class="ibox-title">
              <span class="label label-success pull-right"><%= @current_month %></span>
              <h5>総残業時間</h5>
            </div>
            <div class="ibox-content">
              <h1 class="no-margins">
                <%= number_with_precision(@users.sum(:total_hours), precision: 1) %>h
              </h1>
              <small>全社員合計</small>
            </div>
          </div>
        </div>
      </div>
      
      <!-- 残業時間状況 -->
      <div class="row">
        <div class="col-lg-12">
          <div class="ibox float-e-margins">
            <div class="ibox-title">
              <div class="pull-right">
                <!-- 月ナビゲーション -->
                <% if @target_date.present? %>
                  <% prev_month = @target_date.prev_month.strftime("%Y-%m") %>
                  <% next_month = @target_date.next_month.strftime("%Y-%m") %>
                  
                  <%= link_to root_path(month: prev_month), class: "btn btn-xs btn-default" do %>
                    <i class="fa fa-angle-left"></i> 先月
                  <% end %>
                  
                  <span class="m-l-sm m-r-sm"><%= @current_month %></span>
                  
                  <%= link_to root_path(month: next_month), class: "btn btn-xs btn-default" do %>
                    来月 <i class="fa fa-angle-right"></i>
                  <% end %>
                  
                  <%= link_to root_path, class: "btn btn-xs btn-primary m-l-sm" do %>
                    <i class="fa fa-home"></i> 今月
                  <% end %>
                <% end %>
              </div>
              <h5><i class="fa fa-clock-o"></i> 残業時間状況</h5>
            </div>
            <div class="ibox-content">
              <% if @users.any? %>
                <div class="table-responsive">
                  <table class="table table-striped" id="overtime-table">
                    <thead>
                      <tr>
                        <th width="200">氏名</th>
                        <th width="150">部署</th>
                        <th>残業時間</th>
                        <th width="100" class="text-center">状態</th>
                      </tr>
                    </thead>
                    <tbody>
                      <% @users.each do |user| %>
                        <% 
                          hours = user.total_hours || 0
                          percentage = [(hours / @overtime_limit * 100).to_i, 100].min
                          status = calculate_status(hours, @overtime_limit)
                          
                          text_color_class = if percentage >= 100
                                              'text-danger'
                                            elsif percentage >= 80
                                              'text-warning'
                                            else
                                              ''
                                            end
                        %>
                        <tr>
                          <td>
                            <div class="d-flex align-items-center">
                              <% if user.avatar.attached? %>
                                <%= image_tag user.avatar, 
                                    class: "img-circle", 
                                    style: "width: 32px; height: 32px; margin-right: 10px;", 
                                    alt: user.name %>
                              <% else %>
                                <%= image_tag "https://via.placeholder.com/200x200/f8f8f9/676a6c?text=#{user.name.first}", 
                                    class: "img-circle", 
                                    style: "width: 32px; height: 32px; margin-right: 10px;", 
                                    alt: user.name %>
                              <% end %>
                              <strong><%= user.name %></strong>
                            </div>
                          </td>
                          <td><%= user.department_name %></td>
                          <td>
                            <div>
                              <span class="pull-right <%= text_color_class %> font-bold">
                                <%= number_with_precision(hours, precision: 1) %>h / <%= @overtime_limit.to_i %>h
                              </span>
                              <div class="progress m-t-xs" style="height: 10px;">
                                <div style="width: <%= percentage %>%;" 
                                     class="progress-bar <%= status[:progress_class] %>"
                                     data-percentage="<%= percentage %>">
                                  <span class="sr-only"><%= percentage %>% Complete</span>
                                </div>
                              </div>
                            </div>
                          </td>
                          <td class="text-center">
                            <span class="label <%= status[:label] %>"><%= status[:text] %></span>
                          </td>
                        </tr>
                      <% end %>
                    </tbody>
                  </table>
                </div>
                
                <!-- 凡例 -->
                <div class="m-t-md">
                  <small class="text-muted">
                    <span class="label label-danger">上限到達</span> <%= @overtime_limit.to_i %>時間以上
                    <span class="label label-warning m-l-xs">要注意</span> <%= (@overtime_limit * 0.8).to_i %>時間以上（80%）
                    <span class="label label-info m-l-xs">標準</span> <%= (@overtime_limit * 0.4).to_i %>〜<%= (@overtime_limit * 0.8).to_i - 1 %>時間
                    <span class="label label-success m-l-xs">余裕あり</span> <%= (@overtime_limit * 0.4).to_i %>時間未満
                  </small>
                </div>
                
                <!-- エクスポートボタン -->
                <div class="m-t-md text-right">
                  <%= link_to "#", class: "btn btn-primary btn-sm", id: "export-csv" do %>
                    <i class="fa fa-download"></i> CSVエクスポート
                  <% end %>
                </div>
              <% else %>
                <div class="text-center p-lg">
                  <i class="fa fa-info-circle fa-3x text-muted"></i>
                  <p class="m-t-md text-muted"><%= @current_month %>の残業時間データがありません。</p>
                </div>
              <% end %>
            </div>
          </div>
        </div>
      </div>

    </div>
    <%= render 'shared/footer' %>
  </div>
</div>

<script>
$(document).ready(function() {
    // 月選択ドロップダウンの処理
    $('#month-filter').on('change', function() {
        var url = $(this).val();
        if (url) {
            window.location.href = url;
        }
    });

    // プログレスバーアニメーション
    $('.progress-bar').each(function() {
        var $this = $(this);
        var width = $this.css('width');
        var percentage = $this.data('percentage');
        $this.css('width', 0);
        $this.animate({
            width: width
        }, 1000);
    });
    
    // DataTables初期化（オプション）
    if ($.fn.DataTable && $('#overtime-table tbody tr').length > 10) {
        $('#overtime-table').DataTable({
            pageLength: 25,
            responsive: true,
            language: {
                url: "//cdn.datatables.net/plug-ins/1.10.25/i18n/Japanese.json"
            },
            order: [[2, 'desc']], // 残業時間で降順ソート
            columnDefs: [
                { orderable: false, targets: 3 } // 状態列はソート無効
            ]
        });
    }
    
    // CSVエクスポート
    $('#export-csv').on('click', function(e) {
        e.preventDefault();
        
        var csv = [];
        var headers = ['氏名', '部署', '残業時間(h)', '状態'];
        csv.push(headers.join(','));
        
        $('#overtime-table tbody tr').each(function() {
            var row = [];
            row.push($(this).find('td:eq(0) strong').text());
            row.push($(this).find('td:eq(1)').text());
            row.push($(this).find('td:eq(2) span').text().replace(/h.*/, '').trim());
            row.push($(this).find('td:eq(3) span').text());
            csv.push(row.join(','));
        });
        
        var csvContent = csv.join('\n');
        var blob = new Blob(['\uFEFF' + csvContent], { type: 'text/csv;charset=utf-8;' });
        var link = document.createElement('a');
        var url = URL.createObjectURL(blob);
        link.setAttribute('href', url);
        link.setAttribute('download', '残業時間レポート_<%= @current_month %>.csv');
        link.style.visibility = 'hidden';
        document.body.appendChild(link);
        link.click();
        document.body.removeChild(link);
    });
});
</script>
