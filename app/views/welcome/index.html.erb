<% provide(:title, "日報") %>
<div id="wrapper">
  <%= render 'shared/header' %>
  <div id="page-wrapper" class="gray-bg dashbard-1">
    <%= render 'shared/navbar' %>
    <div class="row wrapper border-bottom white-bg page-heading">
      <div class="col-lg-10">
        <h2>日報</h2>
        <ol class="breadcrumb">
          <li>
            <a href="/admin">日報を書く</a>
          </li>
        </ol>
      </div>
    </div>
    <div class="wrapper wrapper-content">
      <div class="row">
        <div class="col-lg-12">
          <div class="ibox float-e-margins">
            <div class="ibox-content">
              <div id="notifications"></div>
              <form action="/reports" method="POST" class="form-horizontal" id="dailyReportForm">
                <div class="ibox float-e-margins">
                  <div class="ibox-title">
                      <h5>作業一覧</h5>
                  </div>
                  <div class="ibox-content">
                      <div class="row">
                          <div class="col-sm-12 text-right">
                              <button type="button" class="btn btn-success m-b-sm" id="addWorkBtn">
                                  <i class="fa fa-plus"></i> 作業を追加
                              </button>
                          </div>
                      </div>

                      <div id="workList" class="work-list">
                        <%# (※) @daily_report.works は実際の関連名に修正してください %>
                        <%# データがない場合は、空のworkオブジェクトを1つ持つ配列を作成 %>
                        <% works = @daily_report.daily_report_projects.presence || [@daily_report.daily_report_projects.build] %>
                        <% works.each_with_index do |work, index| %>
                          <div class="work-item" data-work-index="<%= index %>">
                              <div class="row">
                                  <div class="col-sm-4">
                                      <div class="form-group">
                                          <label class="control-label">顧客名 <span class="text-danger">*</span></label>
                                          <%# (※) work.project.client.name は実際のモデル関連に合わせてください %>
                                          <input type="text" class="form-control client-input" name="works[<%= index %>][customer]" placeholder="顧客名を入力" required autocomplete="off" value="<%= work.try(:project).try(:client).try(:name) %>">
                                          <input type="hidden" class="client-id" name="works[<%= index %>][client_id]" value="<%= work.try(:project).try(:client_id) %>">
                                          <div class="suggestions-dropdown client-suggestions"></div>
                                      </div>
                                  </div>
                                  <div class="col-sm-4">
                                      <div class="form-group">
                                          <label class="control-label">案件名 <span class="text-danger">*</span></label>
                                          <%# (※) work.project.name は実際のモデル関連に合わせてください %>
                                          <%# 案件IDがなければdisabledにする %>
                                          <input type="text" class="form-control project-input" name="works[<%= index %>][project]" placeholder="案件名を入力" required autocomplete="off" <%= 'disabled' if work.project_id.blank? %> value="<%= work.try(:project).try(:name) %>">
                                          <input type="hidden" class="project-id" name="works[<%= index %>][project_id]" value="<%= work.project_id %>">
                                          <div class="suggestions-dropdown project-suggestions"></div>
                                      </div>
                                  </div>
                                  <div class="col-sm-3">
                                      <div class="form-group">
                                          <label class="control-label">作業時間 <span class="text-danger">*</span></label>
                                          <div class="input-group">
                                              <input type="number" class="form-control" name="works[<%= index %>][hours]" placeholder="0" step="1" min="0" max="1440" required value="<%= work.hours %>">
                                              <span class="input-group-addon">分</span>
                                          </div>
                                      </div>
                                  </div>
                                  <div class="col-sm-1">
                                      <div class="form-group" style="margin-top: 25px;">
                                          <button type="button" class="btn btn-danger btn-sm remove-work-btn">
                                              <i class="fa fa-trash"></i>
                                          </button>
                                      </div>
                                  </div>
                              </div>
                              <div class="row">
                                  <div class="col-sm-12">
                                      <div class="form-group">
                                          <label class="control-label">作業内容</label>
                                          <textarea class="form-control" name="works[<%= index %>][description]" rows="2" placeholder="作業内容を入力（任意）"><%= work.description %></textarea>
                                      </div>
                                  </div>
                              </div>
                              <hr class="hr-line-dashed">
                          </div>
                        <% end %>
                      </div>

                      <div class="row">
                          <div class="col-sm-12">
                              <div class="alert alert-info">
                                  <strong>合計作業時間: <span id="totalHours">0.0</span> 時間</strong>
                              </div>
                          </div>
                      </div>
                  </div>
                </div>

                <div class="ibox float-e-margins">
                    <div class="ibox-title">
                        <h5>本日の日報</h5>
                    </div>
                    <div class="ibox-content">
                        <div class="form-group">
                            <label class="control-label">日付 <span class="text-danger">*</span></label>
                            <input type="date" class="form-control" name="report_date" id="reportDate" required value="<%= @write_date %>">
                        </div>

                        <div class="form-group">
                            <label class="control-label">日報内容 <span class="text-danger">*</span></label>
                            <textarea class="form-control" name="report_content" rows="8" placeholder="本日の業務内容、成果、課題、明日の予定などを記入してください" required><%= @daily_report.content %></textarea>
                            <div class="help-block">
                                <small class="text-muted">業務内容、成果、課題、明日の予定などを具体的に記載してください。</small>
                            </div>
                        </div>
                    </div>
                </div>

                <div class="form-group">
                    <div class="col-sm-12">
                        <div class="text-center">
                            <button type="submit" class="btn btn-primary btn-lg">
                                <i class="fa fa-paper-plane"></i> 日報を提出
                            </button>
                        </div>
                    </div>
                </div>
              </form>
            </div>
          </div>
        </div>
      </div>
      <%= render 'shared/footer' %>
    </div>
  </div>
</div>

<script>
    $(document).ready(function() {
        // 描画済みの作業アイテム数に基づいてインデックスの初期値を設定
        let workIndex = $('.work-item').length;
        const COMPANY_ID = <%= current_user.company_id %>

        // 顧客検索API
        async function searchClients(query) {
            try {
                const response = await fetch(`http://localhost:3000/api/clients.json?company_id=${COMPANY_ID}&name=${encodeURIComponent(query)}`);
                if (!response.ok) throw new Error('API request failed');
                const data = await response.json();
                return data.clients || [];
            } catch (error) {
                console.error('顧客検索エラー:', error);
                return [];
            }
        }

        // 案件検索API
        async function searchProjects(clientId, query = '') {
            try {
                const response = await fetch(`http://localhost:3000/api/projects.json?client_id=${clientId}&name=${encodeURIComponent(query)}`);
                if (!response.ok) throw new Error('API request failed');
                const data = await response.json();
                return data.projects || [];
            } catch (error) {
                console.error('案件検索エラー:', error);
                return [];
            }
        }

        // サジェスト表示
        function showSuggestions(input, suggestions, type) {
            const dropdown = input.siblings('.suggestions-dropdown');
            dropdown.empty().hide();

            if (suggestions.length === 0) return;

            suggestions.forEach(item => {
                const div = $('<div class="suggestion-item"></div>')
                    .text(item.name)
                    .data('id', item.id)
                    .data('name', item.name);
                
                div.click(function() {
                    const id = $(this).data('id');
                    const name = $(this).data('name');
                    
                    input.val(name);
                    
                    if (type === 'client') {
                        input.siblings('.client-id').val(id);
                        const projectInput = input.closest('.work-item').find('.project-input');
                        const projectIdInput = input.closest('.work-item').find('.project-id');
                        projectInput.prop('disabled', false).val('');
                        projectIdInput.val('');
                        loadProjectSuggestions(input.closest('.work-item'), id);
                    } else if (type === 'project') {
                        input.siblings('.project-id').val(id);
                    }
                    
                    dropdown.hide();
                });
                
                dropdown.append(div);
            });

            dropdown.show();
        }

        // 初期案件サジェスト読み込み
        async function loadProjectSuggestions(workItem, clientId) {
            const projectInput = workItem.find('.project-input');
            try {
                const projects = await searchProjects(clientId);
                projectInput.data('allProjects', projects);
            } catch (error) {
                console.error('案件読み込みエラー:', error);
            }
        }

        // --- イベントハンドラ ---
        $(document).on('input', '.client-input', async function() {
            const input = $(this);
            const query = input.val().trim();
            
            input.siblings('.client-id').val('');
            
            const workItem = input.closest('.work-item');
            const projectInput = workItem.find('.project-input');
            const projectIdInput = workItem.find('.project-id');
            projectInput.prop('disabled', true).val('');
            projectIdInput.val('');
            workItem.find('.project-suggestions').hide();

            if (query.length < 1) {
                input.siblings('.client-suggestions').hide();
                return;
            }

            input.addClass('loading');
            try {
                const clients = await searchClients(query);
                showSuggestions(input, clients, 'client');
            } finally {
                input.removeClass('loading');
            }
        });

        $(document).on('input', '.project-input', async function() {
            const input = $(this);
            const query = input.val().trim();
            const workItem = input.closest('.work-item');
            const clientId = workItem.find('.client-id').val();
            
            input.siblings('.project-id').val('');

            if (!clientId) return;

            if (query.length < 1) {
                const allProjects = input.data('allProjects') || [];
                showSuggestions(input, allProjects, 'project');
                return;
            }

            input.addClass('loading');
            try {
                const projects = await searchProjects(clientId, query);
                showSuggestions(input, projects, 'project');
            } finally {
                input.removeClass('loading');
            }
        });

        $(document).on('focus', '.project-input', async function() {
            const input = $(this);
            const workItem = input.closest('.work-item');
            const clientId = workItem.find('.client-id').val();
            
            if (!clientId) return;

            if (input.val().trim() === '') {
                const allProjects = input.data('allProjects');
                if (allProjects && allProjects.length > 0) {
                    showSuggestions(input, allProjects, 'project');
                } else {
                    try {
                        const projects = await searchProjects(clientId);
                        input.data('allProjects', projects);
                        showSuggestions(input, projects, 'project');
                    } catch (error) {
                        console.error('案件読み込みエラー:', error);
                    }
                }
            }
        });

        $(document).on('click', function(e) {
            if (!$(e.target).closest('.form-group').length) {
                $('.suggestions-dropdown').hide();
            }
        });

        $('#addWorkBtn').click(function() {
            const workItem = createWorkItem(workIndex);
            $('#workList').append(workItem);
            workIndex++;
            updateRemoveButtons();
            calculateTotalHours();
        });

        $(document).on('click', '.remove-work-btn', function() {
            $(this).closest('.work-item').remove();
            updateRemoveButtons();
            calculateTotalHours();
        });

        $(document).on('input', 'input[name*="[hours]"]', function() {
            calculateTotalHours();
        });
        
        // --- 関数定義 ---
        function createWorkItem(index) {
            return `
                <div class="work-item" data-work-index="${index}">
                    <div class="row">
                        <div class="col-sm-4">
                            <div class="form-group">
                                <label class="control-label">顧客名 <span class="text-danger">*</span></label>
                                <input type="text" class="form-control client-input" name="works[${index}][customer]" placeholder="顧客名を入力" required autocomplete="off">
                                <input type="hidden" class="client-id" name="works[${index}][client_id]" value="">
                                <div class="suggestions-dropdown client-suggestions"></div>
                            </div>
                        </div>
                        <div class="col-sm-4">
                            <div class="form-group">
                                <label class="control-label">案件名 <span class="text-danger">*</span></label>
                                <input type="text" class="form-control project-input" name="works[${index}][project]" placeholder="案件名を入力" required autocomplete="off" disabled>
                                <input type="hidden" class="project-id" name="works[${index}][project_id]" value="">
                                <div class="suggestions-dropdown project-suggestions"></div>
                            </div>
                        </div>
                        <div class="col-sm-3">
                            <div class="form-group">
                                <label class="control-label">作業時間 <span class="text-danger">*</span></label>
                                <div class="input-group">
                                    <input type="number" class="form-control" name="works[${index}][hours]" placeholder="0" step="1" min="0" max="1440" required>
                                    <span class="input-group-addon">分</span>
                                </div>
                            </div>
                        </div>
                        <div class="col-sm-1">
                            <div class="form-group" style="margin-top: 25px;">
                                <button type="button" class="btn btn-danger btn-sm remove-work-btn">
                                    <i class="fa fa-trash"></i>
                                </button>
                            </div>
                        </div>
                    </div>
                    <div class="row">
                        <div class="col-sm-12">
                            <div class="form-group">
                                <label class="control-label">作業内容</label>
                                <textarea class="form-control" name="works[${index}][description]" rows="2" placeholder="作業内容を入力（任意）"></textarea>
                            </div>
                        </div>
                    </div>
                    <hr class="hr-line-dashed">
                </div>
            `;
        }

        function updateRemoveButtons() {
            const workItems = $('.work-item');
            if (workItems.length <= 1) {
                workItems.find('.remove-work-btn').hide();
            } else {
                workItems.find('.remove-work-btn').show();
            }
        }

        function calculateTotalHours() {
            let totalMinutes = 0;
            $('input[name*="[hours]"]').each(function() {
                const minutes = parseInt($(this).val()) || 0;
                totalMinutes += minutes;
            });
            const totalHours = (totalMinutes / 60).toFixed(1);
            $('#totalHours').text(totalHours);
        }

        $('#dailyReportForm').submit(function(e) {
            const totalMinutes = parseFloat($('#totalHours').text()) * 60;
            if (totalMinutes > 1440) {
                e.preventDefault();
                alert('合計作業時間が24時間を超えています。確認してください。');
                return false;
            }

            let invalidItem = false;
            $('.work-item').each(function() {
                const customer = $(this).find('input[name*="[customer]"]').val();
                const project = $(this).find('input[name*="[project]"]').val();
                const hours = $(this).find('input[name*="[hours]"]').val();
                const clientId = $(this).find('.client-id').val();
                const projectId = $(this).find('.project-id').val();

                if (!customer || !project || !hours || parseInt(hours) <= 0 || !clientId || !projectId) {
                    invalidItem = true;
                }
            });

            if (invalidItem) {
                e.preventDefault();
                alert('作業一覧の必須項目（顧客名、案件名、作業時間）を正しく入力または選択してください。');
                return false;
            }
        });

        // ページ読み込み時の初期化処理
        function initializePage() {
            // 既存の各作業項目に対して、案件サジェストをプリロードする
            $('.work-item').each(function() {
                const workItem = $(this);
                const clientId = workItem.find('.client-id').val();
                if (clientId) {
                    loadProjectSuggestions(workItem, clientId);
                }
            });

            updateRemoveButtons();
            calculateTotalHours();
        }
        
        // ページ読み込み完了時に実行
        initializePage();
    });
</script>